function bloodmallet_chart_import(){const e=["#7cb5ec","#d9d9df","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"],t="#343a40",o="#f8f9fa",l="#828282",i="1.1rem",r=!1,a="https://bloodmallet.com/json/";let s={};function n(e){r&&console.log("load_data");let t=e.data_type,o=e.fight_style,l=e.wow_class,i=e.wow_spec;try{if(s[t][o][l][i])return}catch(e){r&&console.log("Data needs to be loaded.")}let n=t;n.indexOf("azerite")>-1&&(n="azerite_traits");let d=l;d+="_"+i,t.indexOf("azerite_items")>-1&&(d+=t.replace("azerite_items","")),d+="_"+o,d+=".json",r&&console.log("Fetching data from: "+a+n+"/"+d);let c=new XMLHttpRequest;c.open("GET",a+n+"/"+d+"?"+(new Date).getTime(),!0),c.onload=function(e){if(4===c.readyState)if(200===c.status){let e=JSON.parse(c.responseText);s[t]||(s[t]={}),s[t][o]||(s[t][o]={}),s[t][o][l]||(s[t][o][l]={}),s[t][o][l][i]=e,r&&(console.log(e),console.log("Load and save finished."))}else console.error(c.statusText)},c.onerror=function(e){console.error("Fetching data from bloodmallet.com encountered an error, ",e)},c.send(null)}function d(e,t,o,l){r&&console.log("update_charts");let i=e.data_type,a=e.fight_style,n=e.wow_class,g=e.wow_spec,_=e.data_entries,h=e.chart_engine;try{var p=s[i][a][n][g]}catch(r){return console.warn("Data for ",i,a,n,g," wasn't loaded yet. Either chart setup is wrong, connection to bloodmallet.com is slow or failed."),void(l<10&&setTimeout(d,100,e,t,o,l+1))}const u=p;let m,f;if(i.indexOf("azerite_traits")>-1)if("azerite_traits_stacking"===i)"all"===e.azerite_tier?m=u.sorted_data_keys_2.slice(0,u.sorted_data_keys_2.length):"1"===e.azerite_tier||"3"===e.azerite_tier?m=u.sorted_azerite_tier_3_trait_stacking.slice(0,u.sorted_azerite_tier_3_trait_stacking.length):"2"===e.azerite_tier&&(m=u.sorted_azerite_tier_2_trait_stacking.slice(0,u.sorted_azerite_tier_2_trait_stacking.length)),f=u.data.baseline[u.simulated_steps[0]];else{if("azerite_traits_itemlevel"!==i)return void console.log("Chart found, but unknown data-type detected.");"all"===e.azerite_tier?m=u.sorted_data_keys.slice(0,u.sorted_data_keys.length):"1"===e.azerite_tier||"3"===e.azerite_tier?m=u.sorted_azerite_tier_3_itemlevel.slice(0,u.sorted_azerite_tier_3_itemlevel.length):"2"===e.azerite_tier&&(m=u.sorted_azerite_tier_2_itemlevel.slice(0,u.sorted_azerite_tier_2_itemlevel.length)),f=u.data.baseline[u.simulated_steps[u.simulated_steps.length-1]]}else m=u.sorted_data_keys.slice(0,u.sorted_data_keys.length),f="races"===i?0:u.data.baseline[u.simulated_steps[u.simulated_steps.length-1]];r&&(console.log(m),console.log("Baseline dps: "+f));let b=[];if("azerite_traits_stacking"==i){let e=u.simulated_steps[0].replace("1_","");b.push("3_"+e),b.push("2_"+e),b.push("1_"+e)}else b=u.simulated_steps;if(r&&console.log("simulated_steps: "+b),"essences"===i){purge_list=[];for(let t of m)e.filters.hasOwnProperty("essence_types")&&(e.filters.essence_types.indexOf("minor")>-1&&t.indexOf(" minor")>-1?purge_list.push(t):e.filters.essence_types.indexOf("combined")>-1&&-1===t.indexOf(" minor")&&purge_list.push(t));for(let e of purge_list)m.splice(m.indexOf(e),1)}for(m=m.slice(0,_),o.setTitle({text:u.title},{text:u.subtitle},!1);o.series[0];)o.series[0].remove(!1);let y=[];for(let t=0;t<m.length;t++){let o=m[t];y.push(c(e,o,u))}if(r&&console.log(y),"highcharts"==h?o.update({xAxis:{categories:y}},!1):"highcharts_old"==h&&o.xAxis[0].setCategories(y,!1),b)for(let e=0;e<b.length;e++){let t=b[e];var w=[];for(let o=0;o<m.length;o++){t=b[e];let l=b.slice(),r=m[o],a=u.data[r];if(f=u.data.baseline[u.simulated_steps[u.simulated_steps.length-1]],"azerite_traits_stacking"===i&&(f=u.data.baseline[u.simulated_steps[0]]),"azerite_traits_stacking"===i&&void 0===a[t]){let e=u.simulated_steps,o=void 0;for(let t=0;t<e.length;t++){const l=e[t];!o&&u.data[r][l]&&(o=l)}o=o.replace("1_",""),l=[];for(let e of b)l.push(e.split("_")[0]+"_"+o);f=u.data.baseline["1_"+o],t=t.split("_")[0]+"_"+o}Number(a[t])>0?e==b.length-1?t in a?w.push(a[t]-f):w.push(0):0!==a[l[String(Number(e)+1)]]&&l[String(Number(e)+1)]in a?w.push(a[t]-a[l[String(Number(e)+1)]]):w.push(a[t]-f):t in a?w.push(a[t]):w.push(0)}let l=t;["azerite_items_chest","azerite_items_head","azerite_items_shoulders","azerite_traits_itemlevel"].indexOf(i)>-1?l=t.split("_")[1]:"azerite_traits_stacking"===i&&(l=t.split("_")[0]),o.addSeries({data:w,name:l,showInLegend:!0},!1)}else{w=[];for(let e=0;e<m.length;e++){let t=m[e],o=u.data[t];w.push(o)}o.addSeries({data:w,name:"Race",showInLegend:!0},!1)}"trinkets"==i||"azerite_items_chest"==i||"azerite_items_head"==i||"azerite_items_shoulders"==i||"azerite_traits_itemlevel"==i?o.legend.title.attr({text:"Itemlevel"}):"races"===i?o.legend.title.attr({text:""}):"azerite_traits_stacking"===i?o.legend.title.attr({text:"Trait count"}):"essences"===i&&o.legend.title.attr({text:"Rank"}),t.style.height=200+30*m.length+"px","highcharts"==h&&o.setSize(t.style.width,t.style.height),o.redraw(),"highcharts_old"==h&&o.reflow(),"wowdb"==e.tooltip_engine&&setTimeout(function(){!function(e){r&&console.log("readd_wowdb_tooltips");try{CurseTips["wowdb-tooltip"].watchElements(document.getElementById(e).getElementsByTagName("a"))}catch(e){console.log("Setting wowdb (CurseTips) tooltips failed. Error: ",e)}}(t.id)},1)}function c(e,t,o){r&&(console.log("get_category_name"),console.log(t),console.log(o));const l={cn:"cn_CN",en:"en_US",de:"de_DE",es:"es_ES",fr:"fr_FR",it:"it_IT",ko:"ko_KR",pt:"pt_BR",ru:"ru_RU"};if("wowhead"!=e.tooltip_engine&&"wowdb"!=e.tooltip_engine)return o.languages[t][l[e.language]];if("races"===e.data_type)return o.languages[t][l[e.language]];if("wowhead"==e.tooltip_engine){let i=document.createElement("a");if(i.href="https://"+("en"===e.language?"www":e.language)+".wowhead.com/",o.hasOwnProperty("power_ids")&&o.power_ids.hasOwnProperty(t))i.href+="azerite-essence-power/"+o.power_ids[t];else if(o.hasOwnProperty("item_ids")&&o.item_ids.hasOwnProperty(t)){if(i.href+="item="+o.item_ids[t]+"/"+g(t),o.hasOwnProperty("class_id")&&o.hasOwnProperty("used_azerite_traits_per_item")){i.href+="?azerite-powers="+o.class_id;for(let e=0;e<o.used_azerite_traits_per_item[t].length;e++){const l=o.used_azerite_traits_per_item[t][e];i.href+=":"+l.id}}let e=o.simulated_steps[o.simulated_steps.length-1];"string"==typeof e&&e.indexOf("_")>-1&&(e=e.split("_")[1]),i.href+="&ilvl="+e}else o.hasOwnProperty("spell_ids")&&o.spell_ids.hasOwnProperty(t)&&(i.href+="spell="+o.spell_ids[t]+"/"+g(t));try{i.appendChild(document.createTextNode(o.languages[t][l[e.language]]))}catch(e){i.appendChild(document.createTextNode(t)),console.log("Bloodmallet charts: Translation for "+t+" wasn't found. Please help improving the reasource at bloodmallet.com.")}return i.outerHTML}if("wowdb"==e.tooltip_engine){let i=document.createElement("a");i.href="http://www.wowdb.com/";try{i.href+="items/"+o.item_ids[t]}catch(e){r&&(console.log(e),console.log("We're probably looking at a spell."))}if(i.href.indexOf("items")>-1){let e=o.simulated_steps[o.simulated_steps.length-1];if("string"==typeof e&&e.indexOf("_")>-1&&(e=e.split("_")[1]),i.href+="?itemLevel="+e,o.hasOwnProperty("class_id")&&o.hasOwnProperty("used_azerite_traits_per_item")){i.href+="&azerite=",i.href+=o.class_id+":0";for(let e=0;e<o.used_azerite_traits_per_item[t].length;e++){const l=o.used_azerite_traits_per_item[t][e];i.href+=":"+l.id}}}try{i.href+="spells/"+o.spell_ids[t]}catch(e){r&&(console.log(e),console.log("We're probably looking at an item."))}i.dataset.tooltipHref=i.href;try{i.appendChild(document.createTextNode(o.languages[t][l[e.language]]))}catch(e){i.appendChild(document.createTextNode(t)),console.log("Bloodmallet charts: Translation for "+t+" wasn't found. Please help improving the reasource at bloodmallet.com.")}return i.outerHTML}}function g(e){return e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}function _(a){if(r&&console.log("update_chart_style"),"highcharts"==a.chart_engine||"highcharts_old"==a.chart_engine){let r=a.background_color,s=a.axis_color,n=a.font_color,d={chart:{type:"bar",backgroundColor:t,style:{fontFamily:'-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"'}},colors:e,credits:{href:"https://bloodmallet.com/",text:"bloodmallet.com",style:{fontSize:i}},legend:{align:"right",backgroundColor:t,borderColor:l,borderWidth:1,floating:!1,itemMarginBottom:3,itemMarginTop:0,layout:"vertical",reversed:!0,shadow:!1,verticalAlign:"middle",x:0,y:0,itemStyle:{color:o},itemHoverStyle:{color:o},title:{text:" ",style:{color:o}},symbolRadius:0},plotOptions:{bar:{dataLabels:{enabled:!1}},series:{stacking:"normal",borderColor:t,events:{legendItemClick:function(){return!1}},style:{textOutline:!1,fontSize:i}}},series:[{color:o,data:[1,1,3,1,3],name:"b main",showInLegend:!1},{color:t,data:[0,0,0,1,0],name:"b's emptiness",showInLegend:!1},{color:o,data:[0,0,0,1,0],name:"b's finishing touch",showInLegend:!1}],title:{text:"Loading data...",useHTML:!0,style:{color:o,fontSize:i}},subtitle:{text:'...from <a href="https://bloodmallet.com">bloodmallet</a>',useHTML:!0,style:{color:o,fontSize:i}},tooltip:{headerFormat:"<b>{point.x}</b>",shared:!0,backgroundColor:t,borderColor:l,style:{color:o,fontSize:i},useHTML:!0,positioner:function(e,t,o){return{x:o.plotX,y:o.plotY}}},xAxis:{categories:["","","","",""],labels:{useHTML:!0,style:{color:o,fontSize:i}},gridLineWidth:0,gridLineColor:l,lineColor:l,tickColor:l},yAxis:[{labels:{style:{color:l}},min:0,stackLabels:{enabled:!0,formatter:function(){return Intl.NumberFormat().format(this.total)},style:{color:o,textOutline:!1,fontSize:i,fontWeight:"normal"}},title:{text:"Δ Damage per second",style:{color:l}},gridLineWidth:1,gridLineColor:l},{linkedTo:0,opposite:!0,labels:{style:{color:l}},min:0,stackLabels:{enabled:!0,formatter:function(){return Intl.NumberFormat().format(this.total)},style:{color:o,textOutline:!1,fontSize:i,fontWeight:"normal"}},title:{text:"Δ Damage per second",style:{color:l}},gridLineWidth:1,gridLineColor:l}]};return d.chart.backgroundColor=r,d.legend.backgroundColor=r,d.legend.borderColor=s,d.legend.itemStyle.color=n,d.legend.itemHoverStyle.color=n,d.title.style.color=n,d.subtitle.style.color=n,d.tooltip.formatter=function(){let e=document.createElement("div");e.style.margin="-4px -7px -7px -7px",e.style.padding="3px 3px 6px 3px",e.style.backgroundColor=r,"highcharts_old"===a.chart_engine&&(e.style.margin="-7px");let t=document.createElement("div");e.appendChild(t),t.style.marginLeft="9px",t.style.marginRight="9px",t.style.marginBottom="6px",t.style.fontWeight="700",t.innerHTML=this.x;let o=0;for(var l=this.points.length-1;l>=0;l--)if(o+=this.points[l].y,0!==this.points[l].y){let t=document.createElement("div");e.appendChild(t);let i=document.createElement("span");t.appendChild(i),i.style.marginLeft="9px",i.style.borderLeft="9px solid "+this.points[l].series.color,i.style.paddingLeft="4px",i.innerHtml=this.points[l].series.name,t.appendChild(document.createTextNode("  "+Intl.NumberFormat().format(o)))}return e.outerHTML},d.tooltip.backgroundColor=r,d.tooltip.borderColor=s,d.tooltip.style.color=n,d.xAxis.labels.style.color=n,d.xAxis.gridLineColor=s,d.xAxis.lineColor=s,d.xAxis.tickColor=s,d.yAxis[0].labels.style.color=s,d.yAxis[0].stackLabels.style.color=n,d.yAxis[0].gridLineColor=s,d.yAxis[0].lineColor=s,d.yAxis[0].tickColor=s,d.yAxis[0].title.style.color=s,d.yAxis[1].labels.style.color=s,d.yAxis[1].stackLabels.style.color=n,d.yAxis[1].gridLineColor=s,d.yAxis[1].lineColor=s,d.yAxis[1].tickColor=s,d.yAxis[1].title.style.color=s,d.credits.style.color=n,d}}this.init_charts=new function(){r&&console.log("init_charts");let e=document.querySelectorAll("div.bloodmallet_chart, [data-bloodmallet='chart']");for(let a=0;a<e.length;a++){const s=e[a];if(s){var i={wow_class:void 0,wow_spec:void 0,data_type:"trinkets",azerite_tier:"all",fight_style:"patchwerk",filters:{},axis_color:l,background_color:t,font_color:o,data_entries:7,chart_engine:"highcharts",tooltip_engine:"wowhead",language:"en"};try{void 0!==bloodmallet.style.axis_color&&(i.axis_color=bloodmallet.style.axis_color),void 0!==bloodmallet.style.background_color&&(i.background_color=bloodmallet.style.background_color),void 0!==bloodmallet.style.font_color&&(i.font_color=bloodmallet.style.font_color),void 0!==bloodmallet.settings.entries&&(i.data_entries=bloodmallet.settings.entries),void 0!==bloodmallet.settings.chart_engine&&(i.chart_engine=bloodmallet.settings.chart_engine),void 0!==bloodmallet.settings.tooltip_engine&&(i.tooltip_engine=bloodmallet.settings.tooltip_engine),void 0!==bloodmallet.settings.language&&(i.language=bloodmallet.settings.language)}catch(e){r&&console.log("Applying page wide settings failed.")}s.getAttribute("data-entries")&&(i.data_entries=s.getAttribute("data-entries")),s.getAttribute("data-fight-style")&&(i.fight_style=s.getAttribute("data-fight-style")),s.getAttribute("data-type")&&(i.data_type=s.getAttribute("data-type")),s.getAttribute("data-azerite-tier")&&(i.azerite_tier=s.getAttribute("data-azerite-tier")),s.getAttribute("data-background-color")&&(i.background_color=s.getAttribute("data-background-color")),s.getAttribute("data-font-color")&&(i.font_color=s.getAttribute("data-font-color")),s.getAttribute("data-axis-color")&&(i.axis_color=s.getAttribute("data-axis-color")),s.getAttribute("data-tooltip-engine")&&(i.tooltip_engine=s.getAttribute("data-tooltip-engine")),s.getAttribute("data-chart-engine")&&(i.chart_engine=s.getAttribute("data-chart-engine")),s.getAttribute("data-language")&&(i.language=s.getAttribute("data-language")),s.getAttribute("data-filter-essence-types")&&(i.filters.essence_types=s.getAttribute("data-filter-essence-types").split(";"));let e=!0;s.getAttribute("data-wow-class")||(console.error("Required 'data-wow-class' attribute wasn't found in the following element."),console.log(s),e=!1),i.wow_class=s.getAttribute("data-wow-class"),s.getAttribute("data-wow-spec")||(console.error("Required 'data-wow-spec' attribute wasn't found in the following element."),console.log(s),e=!1),i.wow_spec=s.getAttribute("data-wow-spec");let a=_(i),c=!1;if("highcharts"==i.chart_engine)try{c=Highcharts.chart(s,a)}catch(e){return console.error("When trying to create a highcharts chart the following error occured. Did you include the necessary Highcharts scripts?"),void console.log(e)}else if("highcharts_old"==i.chart_engine)try{let e=a;e.chart.renderTo=s,c=new Highcharts.Chart(e)}catch(e){return console.error("When trying to create a highcharts_old chart the following error occured. Did you include the necessary Highcharts scripts?"),void console.log(e)}e?(n(i),setTimeout(d,2e3,i,s,c,0)):c.setTitle({text:"Wrong chart setup"},{text:"Missing 'data-wow-class' or 'data-wow-spec'. See <a href=\"https://github.com/Bloodmallet/bloodmallet.github.io/wiki/How-to-import-charts-or-data\">wiki</a>"})}}}}document.addEventListener("DOMContentLoaded",function(){bloodmallet_chart_import()});
